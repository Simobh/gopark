<div class="container-fluid p-0 vh-100 position-relative overflow-hidden">

  <div class="position-absolute top-0 start-50 translate-middle-x mt-2 mt-md-1 px-md-0 col-12 col-md-9" style="z-index: 1050;">
    <div class="card shadow border-0 mx-1 mx-md-0 bg-white">
      <div class="card-body p-1">
        <div class="row g-2 align-items-center">
          <div class="col-3 col-md-1">
            <a class="navbar-brand" href="#">
              <img src="/assets/images/logo.png" alt="GoPark" class="w-75 h-100 ms-3">
            </a>
          </div>
          <div class="col-9 col-md-3">
            <select [ngModel]="selectedCity$ | async" (ngModelChange)="onCityChange($event)" class="form-select border-0 bg-light text-truncate">
              <option value="all">Toutes les villes</option>
              <option *ngFor="let city of availableCities" [value]="city.id">{{ city.name }}</option>
            </select>
          </div>
          <div class="col-8 col-md-6 position-relative">
            <input
              type="text"
              class="form-control border-0 bg-light"
              placeholder="Adresse..."
              [(ngModel)]="address"
              (input)="onAddressInput()"
              (keyup.enter)="searchAddress()">

            <ul class="list-group position-absolute w-100 shadow-sm" style="z-index: 2000;" *ngIf="suggestions.length > 0">
              <li
                class="list-group-item list-group-item-action cursor-pointer"
                *ngFor="let s of suggestions"
                (click)="selectSuggestion(s)">
                <small>{{ s.fullAddress }}</small>
              </li>
            </ul>
          </div>
          <div class="col-2 col-md-1">
            <button class="btn btn-primary w-100 fw-bold" (click)="searchAddress()"><i class="bi bi-search"></i></button>
          </div>
          <div class="col-2 col-md-1">
            <button class="btn btn-primary w-100 fw-bold" (click)="toggleParkingList()">
              <i  [ngClass]="hide_parking_list ? 'bi bi-chevron-double-left' : 'bi bi-chevron-double-right'"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!hide_parking_list" class="position-absolute bottom-0 bottom-md-auto top-md-0 end-0 mt-md-5 me-md-4 w-100 w-md-25 h-25 h-md-75 py-md-5 d-md-none d-block" style="z-index: 1000;">
    <div class="card shadow-lg border-0 h-100 bg-white bg-opacity-25" style="backdrop-filter: blur(8px); border-radius: 15px 15px 0 0;">
      <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center py-2 px-3 border-0">
         <span>Parkings</span>
        <span class="badge bg-white text-primary" *ngIf="parkings$ | async as list">{{ list.length }} </span>
      </div>
      <div class="card-body overflow-auto p-2 bg-white bg-opacity-25">
        <ng-container *ngIf="parkings$ | async as parkingsList">
          <div *ngFor="let p of parkingsList" class="card mb-2 border-0 shadow-sm border-start border-primary border-5">
            <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-center p-1">
                <div>
                  <h6 class="m-0 fw-bold text-dark">{{ p.name }}</h6>
                  <h6 class="m-0 fw-bold text-dark small text-muted">{{ p.city }}</h6>
                </div>
                <div>
                  <button class="btn btn-sm fw-bold fs-4" (click)="toggleFavorite(p)">
                    <i class="bi" [ngClass]="isFavorite(p.id) ? 'bi-star-fill text-warning' : 'bi-star'"></i>
                  </button>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <p class="text-muted small mb-0"><i class="bi bi-geo-alt-fill text-primary"></i> {{ p.address }}</p>
                <button class="btn btn-sm fw-bold fs-4" (click)="focusOnParking(p)">
                  <i class="bi bi-arrow-right-circle"></i>
                </button>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <div class="d-flex">
                  <span class="badge p-2 me-1" [ngClass]="p.availablePlaces > 5 ? 'bg-success' : 'bg-danger'">
                    Places : {{ p.availablePlaces ?? 'N/A' }}
                  </span>
                  <span class="badge p-2" [ngClass]="p.status == 'Ouvert' ? 'bg-success' : 'bg-danger'">{{ p.status }}</span>
                </div>
                <button class="btn btn-sm fw-bold fs-4"
                        (click)="openReservation(p)"
                        [disabled]="(p.availablePlaces || 0) <= 0"
                        title="Réserver une place">
                  <i class="bi bi-ticket-perforated"
                    [ngClass]="(p.availablePlaces || 0) > 0 ? 'text-primary' : 'text-secondary'"></i>
                </button>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <div *ngIf="!hide_parking_list" class="position-absolute top-2 end-0 mt-4 me-4 h-100 w-25 py-5 d-none d-md-block" style="z-index: 1000;">
    <div class="card shadow border-0 h-100 bg-white bg-opacity-25" style="backdrop-filter: blur(5px);">
      <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
        <span>Parkings</span>
        <span class="badge bg-white text-primary" *ngIf="parkings$ | async as list">{{ list.length }} </span>
      </div>
      <div class="card-body overflow-auto p-2 bg-white bg-opacity-25">
        <ng-container *ngIf="parkings$ | async as parkingsList">
          <div *ngFor="let p of parkingsList" class="card mb-2 border-0 shadow-sm border-start border-primary border-5">
            <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-center p-1">
                <div>
                  <h6 class="m-0 fw-bold text-dark">{{ p.name }}</h6>
                  <h6 class="m-0 fw-bold text-dark small text-muted">{{ p.city }}</h6>
                </div>
                <div>
                  <button class="btn btn-sm fw-bold fs-4" (click)="toggleFavorite(p)">
                    <i class="bi" [ngClass]="isFavorite(p.id) ? 'bi-star-fill text-warning' : 'bi-star'"></i>
                  </button>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <p class="text-muted small mb-0"><i class="bi bi-geo-alt-fill text-primary"></i> {{ p.address }}</p>
                <button class="btn btn-sm fw-bold fs-4" (click)="focusOnParking(p)">
                  <i class="bi bi-arrow-right-circle"></i>
                </button>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <div class="d-flex">
                  <span class="badge p-2 me-1" [ngClass]="p.availablePlaces > 5 ? 'bg-success' : 'bg-danger'">
                    Places : {{ p.availablePlaces ?? 'N/A' }}
                  </span>
                  <span class="badge p-2" [ngClass]="p.status == 'Ouvert' ? 'bg-success' : 'bg-danger'">{{ p.status }}</span>
                </div>
                <button class="btn btn-sm fw-bold fs-4"
                        (click)="openReservation(p)"
                        [disabled]="(p.availablePlaces || 0) <= 0"
                        title="Réserver une place">
                  <i class="bi bi-ticket-perforated"
                    [ngClass]="(p.availablePlaces || 0) > 0 ? 'text-primary' : 'text-secondary'"></i>
                </button>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <ng-container *ngIf="parkings$ | async as parkingsList; else loadingOrEmpty">
  <div *ngIf="!isLoading; else loadingSpinner" class="h-100 position-relative">

    <app-map
      [parkings]="parkingsList"
      [userCoords]="coords"
      (routeCalculated)="handleRoute($event)"
      (reserveClicked)="openReservation($event)">
    </app-map>

    <div *ngIf="routeInfo" class="position-absolute ms-4 shadow-lg bg-white p-3 rounded-4 d-flex align-items-center"
         style="z-index: 1100; top: 120px; min-width: 25%; border: 2px solid #0d6efd;">
      <div class="flex-grow-1">
        <div class="d-flex align-items-center mb-1">
          <i class="bi bi-geo-alt-fill text-primary me-2"></i>
          <span class="fw-bold text-dark">Distance du trajet : {{ routeInfo.distance }} km</span>
        </div>
        <div class="d-flex align-items-center text-muted small">
          <i class="bi bi-clock-history me-2"></i>
          <span>Environ {{ routeInfo.duration }} min</span>
        </div>
      </div>
      <button class="btn btn-outline-danger btn-sm rounded-circle ms-3" (click)="clearRoute()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>
</ng-container>

<ng-template #loadingOrEmpty>
  <div class="d-flex flex-column align-items-center justify-content-center h-100">
    <div class="spinner-border text-primary mb-2"></div>
    <span>Chargement des données...</span>
  </div>
</ng-template>

<ng-template #loadingSpinner>
  <div class="d-flex flex-column align-items-center justify-content-center h-100">
    <div class="spinner-grow text-primary mb-2"></div>
    <span>Mise à jour...</span>
  </div>
</ng-template>

<div class="modal" tabindex="-1" [ngClass]="{'d-block show': showReservationModal}" style="background-color: rgba(0,0,0,0.5); z-index: 1055;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-calendar-check me-2"></i>Réserver une place
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeReservation()"></button>
      </div>

      <div class="modal-body p-4">
        <div class="alert alert-light border border-primary border-start-4 mb-3" *ngIf="selectedParking">
          <strong>{{ selectedParking.name }}</strong><br>
          <small class="text-muted">{{ selectedParking.city }}</small>
        </div>

        <form (ngSubmit)="confirmReservation()">

          <div class="row g-2 mb-3">
            <div class="col-12">
              <label class="form-label fw-bold small text-primary mb-1"><i class="bi bi-box-arrow-in-right me-1"></i> Arrivée</label>
            </div>
            <div class="col-7">
              <input type="date"
                     class="form-control bg-light border-0"
                     [(ngModel)]="bookingForm.arrivalDate"
                     name="arrDate"
                     [min]="minDate">
            </div>
            <div class="col-5">
              <input type="time"
                     class="form-control bg-light border-0"
                     [(ngModel)]="bookingForm.arrival"
                     name="arrTime">
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-12">
              <label class="form-label fw-bold small text-danger mb-1"><i class="bi bi-box-arrow-right me-1"></i> Départ</label>
            </div>
            <div class="col-7">
              <input type="date"
                     class="form-control bg-light border-0"
                     [(ngModel)]="bookingForm.departureDate"
                     name="depDate"
                     [min]="bookingForm.arrivalDate"> </div>
            <div class="col-5">
              <input type="time"
                     class="form-control bg-light border-0"
                     [(ngModel)]="bookingForm.departure"
                     name="depTime">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold small text-muted">Immatriculation <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text border-0 bg-secondary text-white"><i class="bi bi-car-front-fill"></i></span>
              <input type="text"
                     class="form-control bg-light border-0 fw-bold"
                     placeholder="AA-123-BB"
                     [(ngModel)]="bookingForm.plate"
                     name="bookPlate"
                     style="text-transform: uppercase;"
                     maxlength="9">
            </div>
            <div class="form-text small mt-1 ms-1">Format requis : XX-000-XX</div>
          </div>

          <div class="d-flex justify-content-end mt-4">
            <button type="button" class="btn btn-light text-muted fw-bold me-2" (click)="closeReservation()">Annuler</button>
            <button type="submit" class="btn btn-success fw-bold px-4" [disabled]="isLoading">
              <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
              {{ isLoading ? 'Validation...' : 'Confirmer la réservation' }}
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>
