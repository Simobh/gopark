<app-navbar></app-navbar>

<div class="settings-container d-flex align-items-center justify-content-center">
  <div class="card shadow-lg border-0 overflow-hidden main-card d-flex flex-column mt-5">

    <div class="d-flex h-100">

      <div class="sidebar-fixed p-4 d-flex flex-column border-end">
        <div class="d-flex align-items-center mb-4 border-bottom pb-3 border-secondary border-opacity-10">
          <i class="bi bi-gear-fill fs-4 me-2 text-dark"></i>
          <h5 class="mb-0 fw-bold">Paramètres</h5>
        </div>

        <div class="list-group list-group-flush w-100">
          <button type="button" class="list-group-item list-group-item-action border-0 mb-2 rounded d-flex align-items-center"
                  [class.active]="activeTab() === 'profile'" (click)="activeTab.set('profile')">
            <i class="bi bi-person-fill me-2 fs-5"></i> Profil
          </button>

          <button type="button" class="list-group-item list-group-item-action border-0 mb-2 rounded d-flex align-items-center"
                  [class.active]="activeTab() === 'password'" (click)="activeTab.set('password')">
            <i class="bi bi-lock-fill me-2 fs-5"></i> Mot de passe
          </button>

          <button type="button" class="list-group-item list-group-item-action border-0 mb-2 rounded d-flex align-items-center"
                  [class.active]="activeTab() === 'verification'" (click)="activeTab.set('verification')">
            <i class="bi bi-patch-check-fill me-2 fs-5"></i> Vérification
          </button>

          <button type="button" class="list-group-item list-group-item-action border-0 rounded text-danger fw-bold delete-btn text-nowrap d-flex align-items-center"
                  [class.active]="activeTab() === 'delete'" (click)="activeTab.set('delete')">
            <i class="bi bi-trash-fill me-2 fs-5"></i> Supprimer le compte
          </button>
        </div>
      </div>

      <div class="content-fluid bg-light h-100 overflow-auto">

        <div class="p-4">

          <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3 border-secondary border-opacity-10">
            <h4 class="fw-bold mb-0">
              @switch (activeTab()) {
                @case ('profile') { Mon Profil }
                @case ('password') { Mots de passe }
                @case ('verification') { Authentification à deux facteurs }
                @case ('delete') { Supprimer le compte}
              }
            </h4>
            <div class="d-flex gap-2">
              <button class="btn btn-success btn-sm d-flex align-items-center" (click)="goBack()">
                <i class="bi bi-house-door-fill me-1"></i> Retour à l'accueil
              </button>
            </div>
          </div>

          @if (error()) {
            <div class="alert alert-danger mb-4 shadow-sm border-0" role="alert">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error() }}
            </div>
          }
          @if (success()) {
            <div class="alert alert-success mb-4 shadow-sm border-0" role="alert">
              <i class="bi bi-check-circle-fill me-2"></i>{{ success() }}
            </div>
          }

          @if (activeTab() === 'profile') {
          <div class="card border-0 shadow-sm p-4">

            <div class="d-flex align-items-center justify-content-between mb-4">
              <div class="d-flex align-items-center">
                <div class="position-relative">
                   <div class="avatar-placeholder rounded-circle bg-light border d-flex align-items-center justify-content-center text-secondary overflow-hidden">
                      <img [src]="avatarPreviewUrl() ? avatarPreviewUrl() : 'assets/images/unknown.jpg'"
                           alt="Profil" class="w-100 h-100 object-fit-cover">
                   </div>
                   <button type="button" class="btn btn-success rounded-circle position-absolute bottom-0 end-0 d-flex align-items-center justify-content-center shadow p-0"
                           style="width: 32px; height: 32px;" (click)="fileInput.click()" [disabled]="!editMode()">
                      <i class="bi bi-camera-fill text-white" style="font-size: 0.8rem;"></i>
                   </button>
                   <input #fileInput type="file" accept="image/*" class="d-none" (change)="onAvatarSelected($event)" />
                </div>
                <div class="ms-3">
                  <h5 class="fw-bold mb-0">{{ firstName() }} {{ lastName() }}</h5>
                  <small class="text-muted">Gérez vos informations personnelles</small>
                </div>
              </div>

              <button class="btn btn-outline-success btn-sm rounded-pill px-3 d-flex align-items-center"
                      (click)="editMode.set(!editMode())">
                 <i class="bi" [class.bi-pencil]="!editMode()" [class.bi-x-lg]="editMode()"></i>
                 <span class="ms-2">{{ editMode() ? 'Annuler' : 'Modifier' }}</span>
              </button>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label text-muted small fw-bold">Prénom <span class="text-danger">*</span></label>
                <input type="text" class="form-control bg-light border-0 py-2"
                       [value]="firstName()" (input)="firstName.set($any($event.target).value)"
                       [disabled]="!editMode()">
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small fw-bold">Nom <span class="text-danger">*</span></label>
                <input type="text" class="form-control bg-light border-0 py-2"
                       [value]="lastName()" (input)="lastName.set($any($event.target).value)"
                       [disabled]="!editMode()">
              </div>
            </div>

            <div class="row mb-4">
               <div class="col-md-6">
                  <label class="form-label text-muted small fw-bold">Email</label>
                  @if (authService.currentUser(); as user) {
                    <input type="email" class="form-control bg-light border-0 py-2" [value]="user.email" disabled>
                  }
               </div>
               <div class="col-md-6">
                  <label class="form-label text-muted small fw-bold">Téléphone <span class="text-danger">*</span></label>
                  <input type="text" class="form-control bg-light border-0 py-2"
                         [value]="phoneNumber()" (input)="phoneNumber.set($any($event.target).value)"
                         [disabled]="!editMode()">
               </div>
            </div>

            <div class="mb-5">
              <label class="form-label fw-bold small text-muted">Statut de vérification email</label>
              @if (authService.currentUser(); as user) {
                <div class="border rounded p-3 d-flex justify-content-between align-items-center bg-white">
                  <div class="d-flex align-items-center">
                    @if(user.emailVerified) {
                       <i class="bi bi-check-circle-fill me-2 text-success"></i>
                       <span class="fw-bold text-success">Vérifié</span>
                    } @else {
                       <i class="bi bi-x-circle-fill me-2 text-danger"></i>
                       <span class="fw-bold text-danger">Non vérifié</span>
                    }
                  </div>
                  @if (!user.emailVerified) {
                    <button class="btn btn-outline-success btn-sm border-0 fw-bold" (click)="onResendVerification()" [disabled]="loading()">
                       <i class="bi bi-envelope me-2"></i> {{ loading() ? 'Envoi...' : 'Envoyer l\'email' }}
                    </button>
                  }
                </div>
              }
            </div>

            <div class="text-center mt-auto">
              <button class="btn btn-success px-5 py-2 fw-bold shadow-sm" [disabled]="!editMode() || loading()" (click)="onSaveProfile()">
                 {{ loading() ? 'Enregistrement...' : 'Enregistrer' }}
              </button>
            </div>
          </div>
          }

          @if (activeTab() === 'password') {
          <div class="card border-0 shadow-sm p-4">
            <h5 class="mb-2 fw-bold">Changer le mot de passe</h5>
            <p class="text-muted small mb-4">Utilisez un mot de passe fort (8 caractères, majuscule, chiffre).</p>

            <div class="mb-3">
              <label class="form-label text-muted small fw-bold">Mot de passe actuel</label>
              <div class="input-group">
                 <input [type]="showCurrentPassword() ? 'text' : 'password'" class="form-control bg-light border-0 py-2"
                        [value]="currentPassword()" (input)="currentPassword.set($any($event.target).value)" [disabled]="passwordLoading()">
                 <button class="btn btn-light border-0" type="button" (click)="showCurrentPassword.set(!showCurrentPassword())">
                    <i class="bi" [class.bi-eye]="!showCurrentPassword()" [class.bi-eye-slash]="showCurrentPassword()"></i>
                 </button>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label text-muted small fw-bold">Nouveau mot de passe</label>
              <div class="input-group">
                 <input [type]="showNewPassword() ? 'text' : 'password'" class="form-control bg-light border-0 py-2"
                        [value]="newPassword()" (input)="newPassword.set($any($event.target).value)">
                 <button class="btn btn-light border-0" type="button" (click)="showNewPassword.set(!showNewPassword())">
                    <i class="bi" [class.bi-eye]="!showNewPassword()" [class.bi-eye-slash]="showNewPassword()"></i>
                 </button>
              </div>

              @if (newPassword().trim()) {
                <div class="progress mt-2" style="height: 6px;">
                  <div class="progress-bar" [style.width.%]="passwordProgress()"
                       [class.bg-danger]="passwordStrength() === 'Faible'"
                       [class.bg-warning]="passwordStrength() === 'Moyen'"
                       [class.bg-success]="passwordStrength() === 'Fort'"></div>
                </div>
                <small class="text-muted" style="font-size: 0.75rem;">Force : {{ passwordStrength() }}</small>
              }
            </div>

            <div class="mb-4">
              <label class="form-label text-muted small fw-bold">Confirmer le nouveau mot de passe</label>
              <div class="input-group">
                 <input [type]="showConfirmPassword() ? 'text' : 'password'" class="form-control bg-light border-0 py-2"
                        [value]="confirmPassword()" (input)="confirmPassword.set($any($event.target).value)" [disabled]="passwordLoading()">
                 <button class="btn btn-light border-0" type="button" (click)="showConfirmPassword.set(!showConfirmPassword())">
                    <i class="bi" [class.bi-eye]="!showConfirmPassword()" [class.bi-eye-slash]="showConfirmPassword()"></i>
                 </button>
              </div>
               @if (confirmPassword().trim() && confirmPassword().trim() !== newPassword().trim()) {
                  <small class="text-danger mt-1 d-block">Les mots de passe ne correspondent pas.</small>
               }
            </div>

            <button class="btn btn-success mt-3 px-4" (click)="onChangePassword()"
                    [disabled]="passwordLoading() || !canSubmitPasswordForm()">
               {{ passwordLoading() ? 'Mise à jour...' : 'Mettre à jour' }}
            </button>
          </div>
          }

          @if (activeTab() === 'verification') {
            <div class="card border-0 shadow-sm p-4">
              <div class="d-flex justify-content-between align-items-center mb-4">
                  <div>
                    <h5 class="fw-bold mb-1">Authentification à deux facteurs (A2F)</h5>
                    <p class="text-muted small mb-0">Sécurisez votre compte avec une étape supplémentaire.</p>
                  </div>
                  <span class="badge rounded-pill px-3 py-2"
                        [class.bg-success]="authService.hasMFA()"
                        [class.bg-danger]="!authService.hasMFA()">
                        {{ authService.hasMFA() ? 'Activée' : 'Désactivée' }}
                  </span>
              </div>

              @if (authService.hasMFA()) {
                  <div class="alert alert-success bg-opacity-10 border-success text-success">
                    <i class="bi bi-shield-lock-fill me-2"></i> Votre compte est protégé.
                  </div>
                  <button class="btn btn-outline-danger" (click)="onDisableMFA()" [disabled]="mfaLoading()">
                    {{ mfaLoading() ? 'Désactivation...' : 'Désactiver l\'A2F' }}
                  </button>
              } @else {
                  <div class="bg-light p-4 rounded-3 mfa-setup">

                    @if (mfaStep() === 'idle' || mfaStep() === 'needs-reauth' || mfaStep() === 'sending') {
                        <label class="form-label fw-bold">Numéro de téléphone</label>
                        <input class="form-control border-0 mb-2 py-2" placeholder="+33612345678"
                              [value]="mfaPhoneNumber()" (input)="mfaPhoneNumber.set($any($event.target).value)"
                              [disabled]="mfaLoading()"> <div id="recaptcha-container" class="my-2"></div>

                        <button class="btn btn-success mt-3" (click)="onSendMFAVerificationCode()"
                                [disabled]="mfaLoading() || !mfaPhoneNumber().trim()">
                          {{ mfaLoading() ? 'Envoi du code...' : 'Envoyer le code SMS' }}
                        </button>
                    }
                    @else if (mfaStep() === 'verifying') {
                        <label class="form-label fw-bold">Code de vérification</label>
                        <input class="form-control border-0 mb-2 py-2" placeholder="123456"
                              [value]="mfaVerificationCode()" (input)="mfaVerificationCode.set($any($event.target).value)">
                        <div class="d-flex gap-2 mt-3">
                          <button class="btn btn-success" (click)="onVerifyMFA()" [disabled]="mfaLoading()">Vérifier</button>
                          <button class="btn btn-outline-secondary" (click)="onCancelMFA()">Annuler</button>
                        </div>
                    }
                  </div>
              }
            </div>
          }

          @if (activeTab() === 'delete') {
          <div class="card border-0 shadow-sm p-4">
            <div class="alert alert-danger border-0 bg-danger bg-opacity-10 text-danger p-4 rounded-3">
               <h6 class="fw-bold"><i class="bi bi-exclamation-octagon-fill me-2"></i>Suppression définitive</h6>
               <p class="mb-0 small">
                  La suppression de votre compte est irréversible. Toutes vos données seront effacées.
               </p>
            </div>

            <div class="mt-4">
               <label class="fw-bold mb-2">Mot de passe pour confirmer :</label>
               <input type="password" class="form-control bg-light border-0 py-2 mb-3 w-50"
                      placeholder="Votre mot de passe actuel"
                      [value]="deletePassword()" (input)="deletePassword.set($any($event.target).value)">

               <button class="btn btn-danger px-4 py-2 fw-bold" (click)="openDeleteModal()"
                       [disabled]="deleteLoading() || !deletePassword()">
                  {{ deleteLoading() ? 'Suppression...' : 'Supprimer mon compte définitivement' }}
               </button>
            </div>
          </div>
          }

        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-danger" id="deleteAccountModalLabel">Confirmer la suppression</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" [disabled]="deleteLoading()"></button>
      </div>
      <div class="modal-body">
        <h5 class="mb-2">Êtes-vous absolument sûr ?</h5>
        <p class="text-secondary small">Cette action ne peut pas être annulée.</p>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal" [disabled]="deleteLoading()">Annuler</button>
        <button type="button" class="btn btn-danger rounded-pill px-4" (click)="confirmDeleteAccount()" [disabled]="deleteLoading()">
           Oui, supprimer
        </button>
      </div>
    </div>
  </div>
</div>
